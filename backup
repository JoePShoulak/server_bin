#!/bin/bash

# Check if the world/folder name is provided
if [ -z "$1" ]; then
  echo "Error: No world (folder) name provided. Usage: $0 <world> [machine]"
  exit 1
fi

# Set the world/folder and machine
folder=$1                      # First argument is the world/folder name
machine=${2:-HP2}              # Second argument is the machine name, defaulting to HP2

# Determine the IP address based on the machine name
case "$machine" in
  HP2)
    ip_address="10.0.0.181"
    ;;
  HP3)
    ip_address="10.0.0.182"
    ;;
  HP4)
    ip_address="10.0.0.183"
    ;;
  *)
    echo "Error: Invalid machine name. Use HP2, HP3, or HP4."
    exit 1
    ;;
esac

# Check if the folder exists locally
if [ ! -d "/opt/minecraft/$folder" ]; then
  echo "Error: The folder '/opt/minecraft/$folder' does not exist. Aborting backup."
  exit 1
fi

echo "Backing up the server folder '$folder' to $machine ($ip_address)..."

# Perform the rsync operation and suppress error output
rsync -av --delete /opt/minecraft/$folder/ joe@$ip_address:/opt/minecraft/$folder/ 2>/tmp/rsync_error.log
rsync_exit_code=$?

# Handle errors from rsync
if [ $rsync_exit_code -ne 0 ]; then
  echo "Error: Backup failed."
  case $rsync_exit_code in
    255)
      echo "Reason: Unable to connect to $machine ($ip_address). Ensure the machine is online and accessible."
      ;;
    *)
      echo "Reason: Rsync returned error code $rsync_exit_code. Check /tmp/rsync_error.log for details."
      ;;
  esac
  exit $rsync_exit_code
fi

echo "Backup of folder '$folder' completed successfully!"

